<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Probabilistic Machine Learning - Monte Carlo Dropout and Deep Ensemble for Bayesian Deep Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Probabilistic Machine Learning</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notebooks.html" rel="" target="">
 <span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../slides.html" rel="" target="">
 <span class="menu-text">Slides</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#simple-mlp" id="toc-simple-mlp" class="nav-link" data-scroll-target="#simple-mlp">Simple MLP</a></li>
  <li><a href="#deep-ensemble" id="toc-deep-ensemble" class="nav-link" data-scroll-target="#deep-ensemble">Deep ensemble</a></li>
  <li><a href="#dropout-from-scratch" id="toc-dropout-from-scratch" class="nav-link" data-scroll-target="#dropout-from-scratch">Dropout from scratch</a></li>
  <li><a href="#mc-dropout" id="toc-mc-dropout" class="nav-link" data-scroll-target="#mc-dropout">MC-dropout</a></li>
  <li><a href="#mlp-with-residual-connections" id="toc-mlp-with-residual-connections" class="nav-link" data-scroll-target="#mlp-with-residual-connections">MLP with residual connections</a></li>
  <li><a href="#deep-ensemble-with-residual-connections" id="toc-deep-ensemble-with-residual-connections" class="nav-link" data-scroll-target="#deep-ensemble-with-residual-connections">Deep ensemble with residual connections</a></li>
  <li><a href="#mc-dropout-with-residual-connections" id="toc-mc-dropout-with-residual-connections" class="nav-link" data-scroll-target="#mc-dropout-with-residual-connections">MC-dropout with residual connections</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Monte Carlo Dropout and Deep Ensemble for Bayesian Deep Learning</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>References</p>
<ol type="1">
<li>https://cs231n.github.io/neural-networks-2/#reg</li>
<li>https://uvadlc-notebooks.readthedocs.io/en/latest/tutorial_notebooks/DL2/Bayesian_Neural_Networks/dl2_bnn_tut2_student_with_answers.html</li>
<li>https://docs.aws.amazon.com/prescriptive-guidance/latest/ml-quantifying-uncertainty/mc-dropout.html</li>
<li>https://docs.aws.amazon.com/prescriptive-guidance/latest/ml-quantifying-uncertainty/deep-ensembles.html</li>
<li>https://nipunbatra.github.io/papers/2022/buildsys22-nilm.pdf</li>
</ol>
<p><img src="../diagrams/nn-archs.png" class="img-fluid"></p>
<section id="imports" class="level2">
<h2 class="anchored" data-anchor-id="imports">Imports</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Regular Dropout</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'retina'</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Use GPU</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cuda:0"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cuda:0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tueplots <span class="im">import</span> bundles</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update(bundles.beamer_moml())</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Also add despine to the bundle using rcParams</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.spines.right'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.spines.top'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase font size to match Beamer template</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>] <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make background transparent</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.facecolor'</span>] <span class="op">=</span> <span class="st">'none'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Inspired from: https://uvadlc-notebooks.readthedocs.io/en/latest/tutorial_notebooks/DL2/Bayesian_Neural_Networks/dl2_bnn_tut2_student_with_answers.html</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_simple_data_train():</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> torch.linspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">300</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> torch.hstack([x, torch.linspace(<span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">300</span>)])</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> <span class="kw">lambda</span> x: torch.sin(x)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    eps <span class="op">=</span> torch.randn_like(x) <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    f_x <span class="op">=</span> f(x) </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> f_x <span class="op">+</span> eps</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    x_train <span class="op">=</span> x[:, <span class="va">None</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_train, y_train, f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_generic(add_to_plot<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"X"</span>,)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Y"</span>,)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    x_train, y_train, true_func <span class="op">=</span> get_simple_data_train()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    x_all <span class="op">=</span> torch.linspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">1000</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    ax.plot(x_train, y_train, <span class="st">'C0'</span>, marker<span class="op">=</span><span class="st">'o'</span>, ms<span class="op">=</span> <span class="dv">4</span>, linestyle<span class="op">=</span><span class="st">'none'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">'Observations'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    ax.plot(x_all, true_func(x_all), <span class="st">'C1'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">"true function"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> add_to_plot <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        add_to_plot(ax)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="dv">4</span>, frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>plot_generic()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a simple MLP without using nn.Linear</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>input_dim <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>hidden_l1_dim <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>hidden_l2_dim <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_params():</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    W1 <span class="op">=</span> nn.Parameter(torch.randn(input_dim, hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    b1 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    W2 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l1_dim, hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    W3 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l2_dim, <span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    b3 <span class="op">=</span> nn.Parameter(torch.zeros(<span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [W1, b1, W2, b2, W3, b3]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mlp(x, params, p<span class="op">=</span><span class="fl">0.0</span>):</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    W1, b1, W2, b2, W3, b3 <span class="op">=</span> params</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    h1 <span class="op">=</span> torch.tanh(x <span class="op">@</span> W1 <span class="op">+</span> b1)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> torch.tanh(h1 <span class="op">@</span> W2 <span class="op">+</span> b2)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (h2 <span class="op">@</span> W3 <span class="op">+</span> b3).ravel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>train_x, train_y, true_func <span class="op">=</span> get_simple_data_train()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>train_x <span class="op">=</span> train_x.to(device)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>train_y <span class="op">=</span> train_y.to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>train_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>torch.Size([600, 1])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> torch.linspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">1000</span>)[:, <span class="va">None</span>]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>test_x <span class="op">=</span> test_x.to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> init_params()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    y_hat_untrained <span class="op">=</span> mlp(test_x, parameters).ravel()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Detach and convert to numpy</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>y_hat_untrained <span class="op">=</span> y_hat_untrained.cpu().detach().numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_predictions(x_test, y_preds):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        ax.plot(x_test, y_preds, <span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'neural net prediction'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the untrained model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plot_predictions(test_x.cpu(), y_hat_untrained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="simple-mlp" class="level2">
<h2 class="anchored" data-anchor-id="simple-mlp">Simple MLP</h2>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify the train function to pass the dropout flag and dropout probability</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(params, opt, fwd_func, x_train, y_train, epochs<span class="op">=</span><span class="dv">1000</span>, dropout<span class="op">=</span><span class="va">False</span>, p<span class="op">=</span><span class="fl">0.0</span>):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        y_hat <span class="op">=</span> fwd_func(x_train, params, p)  <span class="co"># Pass the dropout flag and probability to fwd_func</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> F.mse_loss(y_hat, y_train)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        opt.zero_grad()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        opt.step()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">300</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">, loss </span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> init_params()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue with optimizer</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(parameters, lr<span class="op">=</span><span class="fl">3e-4</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>trained_params <span class="op">=</span> train(parameters, optimizer, mlp, train_x, train_y, epochs<span class="op">=</span><span class="dv">6000</span>, dropout<span class="op">=</span><span class="va">False</span>, p<span class="op">=</span><span class="fl">0.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 0, loss 20.761
Epoch 300, loss 0.040
Epoch 600, loss 0.015
Epoch 900, loss 0.013
Epoch 1200, loss 0.012
Epoch 1500, loss 0.012
Epoch 1800, loss 0.012
Epoch 2100, loss 0.011
Epoch 2400, loss 0.011
Epoch 2700, loss 0.011
Epoch 3000, loss 0.011
Epoch 3300, loss 0.011
Epoch 3600, loss 0.011
Epoch 3900, loss 0.011
Epoch 4200, loss 0.010
Epoch 4500, loss 0.010
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.010
Epoch 5700, loss 0.010</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the trained model</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    y_hat_trained <span class="op">=</span> mlp(test_x, trained_params).ravel()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Detach and convert to numpy</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>y_hat_trained <span class="op">=</span> y_hat_trained.cpu().detach().numpy()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>plot_predictions(test_x.cpu(), y_hat_trained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="deep-ensemble" class="level2">
<h2 class="anchored" data-anchor-id="deep-ensemble">Deep ensemble</h2>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a simple MLP without using nn.Linear</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>input_dim <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>hidden_l1_dim <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>hidden_l2_dim <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_params():</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    W1 <span class="op">=</span> nn.Parameter(torch.randn(input_dim, hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    b1 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    W2 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l1_dim, hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    W3 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l2_dim, <span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    b3 <span class="op">=</span> nn.Parameter(torch.zeros(<span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [W1, b1, W2, b2, W3, b3]</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mlp(x, params, p<span class="op">=</span><span class="fl">0.0</span>):</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    W1, b1, W2, b2, W3, b3 <span class="op">=</span> params</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    h1 <span class="op">=</span> torch.tanh(x <span class="op">@</span> W1 <span class="op">+</span> b1)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> torch.tanh(h1 <span class="op">@</span> W2 <span class="op">+</span> b2)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (h2 <span class="op">@</span> W3 <span class="op">+</span> b3).ravel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>n_ensembles <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>ensemble_params_list <span class="op">=</span> []</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_ensembles):</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training ensemble member </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    parameters <span class="op">=</span> init_params()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(parameters, lr<span class="op">=</span><span class="fl">3e-4</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    trained_params <span class="op">=</span> train(parameters, optimizer, mlp, train_x, train_y, epochs<span class="op">=</span><span class="dv">6000</span>, dropout<span class="op">=</span><span class="va">False</span>, p<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    ensemble_params_list.append(trained_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training ensemble member 0
Epoch 0, loss 3.468
Epoch 300, loss 0.038
Epoch 600, loss 0.020
Epoch 900, loss 0.014
Epoch 1200, loss 0.012
Epoch 1500, loss 0.011
Epoch 1800, loss 0.011
Epoch 2100, loss 0.010
Epoch 2400, loss 0.010
Epoch 2700, loss 0.010
Epoch 3000, loss 0.010
Epoch 3300, loss 0.010
Epoch 3600, loss 0.010
Epoch 3900, loss 0.010
Epoch 4200, loss 0.010
Epoch 4500, loss 0.010
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.009
Epoch 5700, loss 0.009
Training ensemble member 1
Epoch 0, loss 34.524
Epoch 300, loss 0.042
Epoch 600, loss 0.022
Epoch 900, loss 0.015
Epoch 1200, loss 0.014
Epoch 1500, loss 0.013
Epoch 1800, loss 0.013
Epoch 2100, loss 0.013
Epoch 2400, loss 0.013
Epoch 2700, loss 0.012
Epoch 3000, loss 0.012
Epoch 3300, loss 0.012
Epoch 3600, loss 0.012
Epoch 3900, loss 0.012
Epoch 4200, loss 0.012
Epoch 4500, loss 0.012
Epoch 4800, loss 0.012
Epoch 5100, loss 0.011
Epoch 5400, loss 0.011
Epoch 5700, loss 0.011
Training ensemble member 2
Epoch 0, loss 8.979
Epoch 300, loss 0.019
Epoch 600, loss 0.013
Epoch 900, loss 0.011
Epoch 1200, loss 0.011
Epoch 1500, loss 0.010
Epoch 1800, loss 0.010
Epoch 2100, loss 0.010
Epoch 2400, loss 0.010
Epoch 2700, loss 0.010
Epoch 3000, loss 0.010
Epoch 3300, loss 0.010
Epoch 3600, loss 0.010
Epoch 3900, loss 0.010
Epoch 4200, loss 0.010
Epoch 4500, loss 0.010
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.010
Epoch 5700, loss 0.010
Training ensemble member 3
Epoch 0, loss 51.558
Epoch 300, loss 0.151
Epoch 600, loss 0.070
Epoch 900, loss 0.019
Epoch 1200, loss 0.013
Epoch 1500, loss 0.012
Epoch 1800, loss 0.011
Epoch 2100, loss 0.011
Epoch 2400, loss 0.010
Epoch 2700, loss 0.010
Epoch 3000, loss 0.010
Epoch 3300, loss 0.010
Epoch 3600, loss 0.010
Epoch 3900, loss 0.010
Epoch 4200, loss 0.010
Epoch 4500, loss 0.010
Epoch 4800, loss 0.010
Epoch 5100, loss 0.009
Epoch 5400, loss 0.009
Epoch 5700, loss 0.009
Training ensemble member 4
Epoch 0, loss 12.525
Epoch 300, loss 0.100
Epoch 600, loss 0.062
Epoch 900, loss 0.021
Epoch 1200, loss 0.015
Epoch 1500, loss 0.013
Epoch 1800, loss 0.012
Epoch 2100, loss 0.011
Epoch 2400, loss 0.010
Epoch 2700, loss 0.010
Epoch 3000, loss 0.010
Epoch 3300, loss 0.010
Epoch 3600, loss 0.010
Epoch 3900, loss 0.010
Epoch 4200, loss 0.010
Epoch 4500, loss 0.010
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.010
Epoch 5700, loss 0.010</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the trained model</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_deep_ensemble(x_test, y_preds_list):</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, y_preds <span class="kw">in</span> <span class="bu">enumerate</span>(y_preds_list, <span class="dv">1</span>):</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>            ax.plot(x_test, y_preds, <span class="ss">f'C</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, label<span class="op">=</span><span class="ss">f'neural net prediction </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>y_preds_list <span class="op">=</span> []</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trained_params <span class="kw">in</span> ensemble_params_list:</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        y_hat_trained <span class="op">=</span> mlp(test_x, trained_params)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        y_hat_trained <span class="op">=</span> y_hat_trained.cpu().numpy()</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        y_preds_list.append(y_hat_trained)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>plot_deep_ensemble(test_x.cpu(), y_preds_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_deep_ensemble_uncertainty(x_test, y_preds_list):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        y_mean <span class="op">=</span> np.array(y_preds_list).mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        y_std <span class="op">=</span> np.array(y_preds_list).std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        ax.plot(x_test, y_mean, <span class="ss">f'C2'</span>, label<span class="op">=</span><span class="ss">f'mean_prediction'</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(x_test.ravel(), y_mean <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>y_std, y_mean <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>y_std, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>plot_deep_ensemble_uncertainty(test_x.cpu(), y_preds_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_just_uncertainty_deep_ensemble(x_test, y_preds_list):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        y_std <span class="op">=</span> np.array(y_preds_list).std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(x_test.ravel(), <span class="op">-</span><span class="dv">2</span><span class="op">*</span>y_std, <span class="dv">2</span><span class="op">*</span>y_std, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>plot_just_uncertainty_deep_ensemble(test_x.cpu(), y_preds_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="dropout-from-scratch" class="level2">
<h2 class="anchored" data-anchor-id="dropout-from-scratch">Dropout from scratch</h2>
<p><img src="https://i.ytimg.com/vi/D8PJAL-MZv8/hqdefault.jpg" class="img-fluid"></p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Now adding dropout to the model by manually masking the activations</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>W1, b1, W2, b2, W3, b3 <span class="op">=</span> parameters</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>h1 <span class="op">=</span> torch.tanh(test_x <span class="op">@</span> W1 <span class="op">+</span> b1)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>h1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>torch.Size([1000, 100])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of dropping out each neuron</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fl">0.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> torch.rand_like(h1) <span class="op">&gt;</span> p</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>torch.Size([1000, 100])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>h1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>torch.Size([1000, 100])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>mask.<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>tensor(79933, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>mask.numel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>100000</code></pre>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>masked_activations <span class="op">=</span> (h1 <span class="op">*</span> mask)<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>p)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>masked_activations.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>torch.Size([1000, 100])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> nn.Dropout(p<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>out_h <span class="op">=</span> m(h1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(out_h.cpu().detach().numpy()).head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">90</th>
<th data-quarto-table-cell-role="th">91</th>
<th data-quarto-table-cell-role="th">92</th>
<th data-quarto-table-cell-role="th">93</th>
<th data-quarto-table-cell-role="th">94</th>
<th data-quarto-table-cell-role="th">95</th>
<th data-quarto-table-cell-role="th">96</th>
<th data-quarto-table-cell-role="th">97</th>
<th data-quarto-table-cell-role="th">98</th>
<th data-quarto-table-cell-role="th">99</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.280216</td>
<td>-0.000000</td>
<td>-0.372197</td>
<td>-0.000000</td>
<td>0.000000</td>
<td>0.346530</td>
<td>0.000000</td>
<td>-0.000000</td>
<td>-0.000000</td>
<td>1.226020</td>
<td>...</td>
<td>-0.667853</td>
<td>0.510881</td>
<td>1.116930</td>
<td>-1.071659</td>
<td>0.000000</td>
<td>-1.239488</td>
<td>0.782513</td>
<td>-0.000000</td>
<td>-1.115131</td>
<td>0.299465</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.278635</td>
<td>-1.232603</td>
<td>-0.370602</td>
<td>-1.182943</td>
<td>1.102740</td>
<td>0.000000</td>
<td>1.181993</td>
<td>-0.631225</td>
<td>-0.738800</td>
<td>1.225449</td>
<td>...</td>
<td>-0.665564</td>
<td>0.508894</td>
<td>0.000000</td>
<td>-1.069398</td>
<td>0.000000</td>
<td>-1.239203</td>
<td>0.779832</td>
<td>-0.965390</td>
<td>-1.113328</td>
<td>0.298324</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.277052</td>
<td>-0.000000</td>
<td>-0.369005</td>
<td>-1.181741</td>
<td>0.000000</td>
<td>0.343636</td>
<td>1.180778</td>
<td>-0.628681</td>
<td>-0.735845</td>
<td>1.224865</td>
<td>...</td>
<td>-0.663269</td>
<td>0.506903</td>
<td>1.113202</td>
<td>-1.067112</td>
<td>1.168637</td>
<td>-0.000000</td>
<td>0.777140</td>
<td>-0.962910</td>
<td>-1.111502</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.275469</td>
<td>-1.231721</td>
<td>-0.367408</td>
<td>-1.180517</td>
<td>1.098915</td>
<td>0.000000</td>
<td>1.179542</td>
<td>-0.626130</td>
<td>-0.732877</td>
<td>1.224268</td>
<td>...</td>
<td>-0.000000</td>
<td>0.504909</td>
<td>1.111301</td>
<td>-0.000000</td>
<td>1.167272</td>
<td>-1.238610</td>
<td>0.000000</td>
<td>-0.960412</td>
<td>-1.109653</td>
<td>0.296039</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.273885</td>
<td>-1.231263</td>
<td>-0.000000</td>
<td>-1.179272</td>
<td>1.096968</td>
<td>0.340738</td>
<td>1.178285</td>
<td>-0.623572</td>
<td>-0.729897</td>
<td>1.223656</td>
<td>...</td>
<td>-0.658661</td>
<td>0.000000</td>
<td>1.109375</td>
<td>-1.062458</td>
<td>1.165885</td>
<td>-0.000000</td>
<td>0.771719</td>
<td>-0.957894</td>
<td>-1.107781</td>
<td>0.294896</td>
</tr>
</tbody>
</table>

<p>5 rows  100 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(h1.cpu().detach().numpy()<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>p)).head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">90</th>
<th data-quarto-table-cell-role="th">91</th>
<th data-quarto-table-cell-role="th">92</th>
<th data-quarto-table-cell-role="th">93</th>
<th data-quarto-table-cell-role="th">94</th>
<th data-quarto-table-cell-role="th">95</th>
<th data-quarto-table-cell-role="th">96</th>
<th data-quarto-table-cell-role="th">97</th>
<th data-quarto-table-cell-role="th">98</th>
<th data-quarto-table-cell-role="th">99</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.280216</td>
<td>-1.233028</td>
<td>-0.372197</td>
<td>-1.184125</td>
<td>1.104618</td>
<td>0.346530</td>
<td>1.183187</td>
<td>-0.633762</td>
<td>-0.741743</td>
<td>1.226020</td>
<td>...</td>
<td>-0.667853</td>
<td>0.510881</td>
<td>1.116930</td>
<td>-1.071659</td>
<td>1.171302</td>
<td>-1.239488</td>
<td>0.782513</td>
<td>-0.967852</td>
<td>-1.115131</td>
<td>0.299465</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.278635</td>
<td>-1.232603</td>
<td>-0.370602</td>
<td>-1.182943</td>
<td>1.102740</td>
<td>0.345083</td>
<td>1.181993</td>
<td>-0.631225</td>
<td>-0.738800</td>
<td>1.225449</td>
<td>...</td>
<td>-0.665564</td>
<td>0.508894</td>
<td>1.115078</td>
<td>-1.069398</td>
<td>1.169980</td>
<td>-1.239203</td>
<td>0.779832</td>
<td>-0.965390</td>
<td>-1.113328</td>
<td>0.298324</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.277052</td>
<td>-1.232167</td>
<td>-0.369005</td>
<td>-1.181740</td>
<td>1.100839</td>
<td>0.343636</td>
<td>1.180778</td>
<td>-0.628681</td>
<td>-0.735845</td>
<td>1.224865</td>
<td>...</td>
<td>-0.663269</td>
<td>0.506903</td>
<td>1.113202</td>
<td>-1.067111</td>
<td>1.168637</td>
<td>-1.238910</td>
<td>0.777139</td>
<td>-0.962910</td>
<td>-1.111502</td>
<td>0.297182</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.275469</td>
<td>-1.231721</td>
<td>-0.367408</td>
<td>-1.180517</td>
<td>1.098915</td>
<td>0.342187</td>
<td>1.179542</td>
<td>-0.626130</td>
<td>-0.732877</td>
<td>1.224268</td>
<td>...</td>
<td>-0.660968</td>
<td>0.504909</td>
<td>1.111301</td>
<td>-1.064798</td>
<td>1.167272</td>
<td>-1.238610</td>
<td>0.774435</td>
<td>-0.960412</td>
<td>-1.109653</td>
<td>0.296039</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.273885</td>
<td>-1.231263</td>
<td>-0.365808</td>
<td>-1.179272</td>
<td>1.096968</td>
<td>0.340738</td>
<td>1.178285</td>
<td>-0.623572</td>
<td>-0.729897</td>
<td>1.223656</td>
<td>...</td>
<td>-0.658661</td>
<td>0.502913</td>
<td>1.109375</td>
<td>-1.062458</td>
<td>1.165885</td>
<td>-1.238301</td>
<td>0.771719</td>
<td>-0.957894</td>
<td>-1.107781</td>
<td>0.294896</td>
</tr>
</tbody>
</table>

<p>5 rows  100 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(masked_activations.cpu().detach().numpy()).head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">90</th>
<th data-quarto-table-cell-role="th">91</th>
<th data-quarto-table-cell-role="th">92</th>
<th data-quarto-table-cell-role="th">93</th>
<th data-quarto-table-cell-role="th">94</th>
<th data-quarto-table-cell-role="th">95</th>
<th data-quarto-table-cell-role="th">96</th>
<th data-quarto-table-cell-role="th">97</th>
<th data-quarto-table-cell-role="th">98</th>
<th data-quarto-table-cell-role="th">99</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.224173</td>
<td>-0.986423</td>
<td>-0.297758</td>
<td>-0.947300</td>
<td>0.883695</td>
<td>0.277224</td>
<td>0.946549</td>
<td>-0.507009</td>
<td>-0.593395</td>
<td>0.980816</td>
<td>...</td>
<td>-0.000000</td>
<td>0.408705</td>
<td>0.000000</td>
<td>-0.857327</td>
<td>0.937041</td>
<td>-0.991591</td>
<td>0.626010</td>
<td>-0.000000</td>
<td>-0.892105</td>
<td>0.239572</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.222908</td>
<td>-0.000000</td>
<td>-0.296482</td>
<td>-0.946354</td>
<td>0.882192</td>
<td>0.276067</td>
<td>0.945594</td>
<td>-0.504980</td>
<td>-0.000000</td>
<td>0.980359</td>
<td>...</td>
<td>-0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>-0.000000</td>
<td>0.935984</td>
<td>-0.991363</td>
<td>0.623866</td>
<td>-0.000000</td>
<td>-0.890662</td>
<td>0.238659</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.221642</td>
<td>-0.000000</td>
<td>-0.000000</td>
<td>-0.000000</td>
<td>0.000000</td>
<td>0.274909</td>
<td>0.944622</td>
<td>-0.502945</td>
<td>-0.588676</td>
<td>0.979892</td>
<td>...</td>
<td>-0.530616</td>
<td>0.000000</td>
<td>0.890561</td>
<td>-0.853689</td>
<td>0.000000</td>
<td>-0.991128</td>
<td>0.621712</td>
<td>-0.000000</td>
<td>-0.889202</td>
<td>0.237745</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.220375</td>
<td>-0.985376</td>
<td>-0.293926</td>
<td>-0.944414</td>
<td>0.000000</td>
<td>0.273750</td>
<td>0.943634</td>
<td>-0.000000</td>
<td>-0.586302</td>
<td>0.979414</td>
<td>...</td>
<td>-0.528775</td>
<td>0.403928</td>
<td>0.000000</td>
<td>-0.851838</td>
<td>0.933818</td>
<td>-0.990888</td>
<td>0.619548</td>
<td>-0.768329</td>
<td>-0.887722</td>
<td>0.236831</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.000000</td>
<td>-0.985010</td>
<td>-0.292647</td>
<td>-0.000000</td>
<td>0.877574</td>
<td>0.272590</td>
<td>0.942628</td>
<td>-0.498858</td>
<td>-0.583917</td>
<td>0.978925</td>
<td>...</td>
<td>-0.526929</td>
<td>0.000000</td>
<td>0.000000</td>
<td>-0.849966</td>
<td>0.932708</td>
<td>-0.990641</td>
<td>0.617375</td>
<td>-0.000000</td>
<td>-0.886225</td>
<td>0.235917</td>
</tr>
</tbody>
</table>

<p>5 rows  100 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>mask_pytorch <span class="op">=</span> h1<span class="op">!=</span>out_h<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>p)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>mask_pytorch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>tensor([[ True,  True, False,  ...,  True,  True,  True],
        [ True,  True, False,  ..., False, False, False],
        [False,  True, False,  ..., False, False,  True],
        ...,
        [False, False, False,  ...,  True, False, False],
        [ True, False, False,  ...,  True,  True, False],
        [ True, False,  True,  ...,  True, False,  True]], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(mask.cpu().detach().numpy()).head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">90</th>
<th data-quarto-table-cell-role="th">91</th>
<th data-quarto-table-cell-role="th">92</th>
<th data-quarto-table-cell-role="th">93</th>
<th data-quarto-table-cell-role="th">94</th>
<th data-quarto-table-cell-role="th">95</th>
<th data-quarto-table-cell-role="th">96</th>
<th data-quarto-table-cell-role="th">97</th>
<th data-quarto-table-cell-role="th">98</th>
<th data-quarto-table-cell-role="th">99</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>...</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>...</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>...</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>True</td>
</tr>
</tbody>
</table>

<p>5 rows  100 columns</p>
</div>
</div>
</div>
</section>
<section id="mc-dropout" class="level2">
<h2 class="anchored" data-anchor-id="mc-dropout">MC-dropout</h2>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Rewriting the model with dropout</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mlp_dropout(x, params, p<span class="op">=</span><span class="fl">0.0</span>, training<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    W1, b1, W2, b2, W3, b3 <span class="op">=</span> params</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    h1 <span class="op">=</span> torch.tanh(x <span class="op">@</span> W1 <span class="op">+</span> b1)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#h2 = torch.sin(h1 @ W2 + b2)</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#h3 = h2 @ W3 + b3</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#return h3</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> training:</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># probability of dropping out each neuron</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.rand_like(h1) <span class="op">&gt;</span> p</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        h1 <span class="op">=</span> h1 <span class="op">*</span> mask</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scale activations to account for dropout</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        h1 <span class="op">=</span> h1 <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> p)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> torch.tanh(h1 <span class="op">@</span> W2 <span class="op">+</span> b2)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> training:</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># probability of dropping out each neuron</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.rand_like(h2) <span class="op">&gt;</span> p</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> h2 <span class="op">*</span> mask</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scale activations to account for dropout</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> h2 <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> p)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    h3 <span class="op">=</span> h2 <span class="op">@</span> W3 <span class="op">+</span> b3</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> h3.ravel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> init_params()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue with optimizer</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(parameters, lr<span class="op">=</span><span class="fl">3e-4</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>trained_params <span class="op">=</span> train(parameters, optimizer, mlp_dropout, train_x, train_y, epochs<span class="op">=</span><span class="dv">10000</span>, dropout<span class="op">=</span><span class="va">True</span>, p<span class="op">=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 0, loss 44.786
Epoch 300, loss 9.598
Epoch 600, loss 7.986
Epoch 900, loss 6.820
Epoch 1200, loss 4.998
Epoch 1500, loss 5.564
Epoch 1800, loss 4.685
Epoch 2100, loss 4.184
Epoch 2400, loss 3.587
Epoch 2700, loss 3.388
Epoch 3000, loss 3.114
Epoch 3300, loss 2.926
Epoch 3600, loss 2.245
Epoch 3900, loss 2.271
Epoch 4200, loss 1.819
Epoch 4500, loss 1.889
Epoch 4800, loss 1.622
Epoch 5100, loss 1.395
Epoch 5400, loss 1.058
Epoch 5700, loss 0.993
Epoch 6000, loss 0.838
Epoch 6300, loss 0.794
Epoch 6600, loss 0.623
Epoch 6900, loss 0.541
Epoch 7200, loss 0.531
Epoch 7500, loss 0.395
Epoch 7800, loss 0.387
Epoch 8100, loss 0.318
Epoch 8400, loss 0.274
Epoch 8700, loss 0.270
Epoch 9000, loss 0.222
Epoch 9300, loss 0.223
Epoch 9600, loss 0.210
Epoch 9900, loss 0.194</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions with dropout</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    y_hat_dropout <span class="op">=</span> mlp_dropout(test_x, trained_params, training<span class="op">=</span><span class="va">False</span>).ravel()</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Detach and convert to numpy</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>y_hat_dropout <span class="op">=</span> y_hat_dropout.cpu().detach().numpy()</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>plot_predictions(test_x.cpu(), y_hat_dropout)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-37-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predictions for the test set with dropout set to True</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> []</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        y_hat_dropout <span class="op">=</span> mlp_dropout(test_x, trained_params, training<span class="op">=</span><span class="va">True</span>, p<span class="op">=</span>p).ravel()</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detach and convert to numpy</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    y_hat_dropout <span class="op">=</span> y_hat_dropout.cpu().detach().numpy()</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    preds.append(y_hat_dropout)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot MC dropout predictions</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> np.array(preds)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>(100, 1000)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and variance of MC dropout predictions</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> preds.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>std <span class="op">=</span> preds.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_predictions_with_uncertainty(x_test, y_preds, y_std):</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>        ax.plot(x_test, y_preds, <span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'neural net prediction'</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(x_test.ravel(), y_preds <span class="op">-</span> y_std, y_preds <span class="op">+</span> y_std, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'uncertainty'</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>plot_predictions_with_uncertainty(test_x.cpu(), mean, std)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Just plot the uncertainty</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_uncertainty(x_test, y_std):</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(x_test.ravel(), <span class="op">-</span>y_std, y_std, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'uncertainty'</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>plot_uncertainty(test_x.cpu(), std)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="mlp-with-residual-connections" class="level2">
<h2 class="anchored" data-anchor-id="mlp-with-residual-connections">MLP with residual connections</h2>
<blockquote class="blockquote">
<p>We need to have same number of neurons in all layers to form a residual connection.</p>
</blockquote>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a simple MLP without using nn.Linear</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>input_dim <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>hidden_l1_dim <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>hidden_l2_dim <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_params():</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    W1 <span class="op">=</span> nn.Parameter(torch.randn(input_dim, hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    b1 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    W2 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l1_dim, hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    W3 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l2_dim, <span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    b3 <span class="op">=</span> nn.Parameter(torch.zeros(<span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [W1, b1, W2, b2, W3, b3]</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mlp(x, params, p<span class="op">=</span><span class="fl">0.0</span>):</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    W1, b1, W2, b2, W3, b3 <span class="op">=</span> params</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    h1 <span class="op">=</span> torch.tanh(x <span class="op">@</span> W1 <span class="op">+</span> b1)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> torch.tanh(h1 <span class="op">@</span> W2 <span class="op">+</span> b2)</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># residual connection</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> h2 <span class="op">+</span> h1</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (h2 <span class="op">@</span> W3 <span class="op">+</span> b3).ravel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> init_params()</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue with optimizer</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(parameters, lr<span class="op">=</span><span class="fl">3e-4</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>trained_params <span class="op">=</span> train(parameters, optimizer, mlp, train_x, train_y, epochs<span class="op">=</span><span class="dv">6000</span>, dropout<span class="op">=</span><span class="va">False</span>, p<span class="op">=</span><span class="fl">0.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 0, loss 5.608
Epoch 300, loss 0.153
Epoch 600, loss 0.050
Epoch 900, loss 0.030
Epoch 1200, loss 0.018
Epoch 1500, loss 0.016
Epoch 1800, loss 0.015
Epoch 2100, loss 0.014
Epoch 2400, loss 0.014
Epoch 2700, loss 0.013
Epoch 3000, loss 0.013
Epoch 3300, loss 0.013
Epoch 3600, loss 0.012
Epoch 3900, loss 0.012
Epoch 4200, loss 0.011
Epoch 4500, loss 0.010
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.010
Epoch 5700, loss 0.009</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the trained model</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    y_hat_trained <span class="op">=</span> mlp(test_x, trained_params).ravel()</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Detach and convert to numpy</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>y_hat_trained <span class="op">=</span> y_hat_trained.cpu().detach().numpy()</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>plot_predictions(test_x.cpu(), y_hat_trained)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="deep-ensemble-with-residual-connections" class="level2">
<h2 class="anchored" data-anchor-id="deep-ensemble-with-residual-connections">Deep ensemble with residual connections</h2>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>n_ensembles <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>ensemble_params_list <span class="op">=</span> []</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_ensembles):</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training ensemble member </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    parameters <span class="op">=</span> init_params()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(parameters, lr<span class="op">=</span><span class="fl">3e-4</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    trained_params <span class="op">=</span> train(parameters, optimizer, mlp, train_x, train_y, epochs<span class="op">=</span><span class="dv">6000</span>, dropout<span class="op">=</span><span class="va">False</span>, p<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    ensemble_params_list.append(trained_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training ensemble member 0
Epoch 0, loss 2.491
Epoch 300, loss 0.038
Epoch 600, loss 0.018
Epoch 900, loss 0.015
Epoch 1200, loss 0.015
Epoch 1500, loss 0.014
Epoch 1800, loss 0.014
Epoch 2100, loss 0.013
Epoch 2400, loss 0.013
Epoch 2700, loss 0.013
Epoch 3000, loss 0.013
Epoch 3300, loss 0.012
Epoch 3600, loss 0.012
Epoch 3900, loss 0.012
Epoch 4200, loss 0.011
Epoch 4500, loss 0.011
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.010
Epoch 5700, loss 0.010
Training ensemble member 1
Epoch 0, loss 1.597
Epoch 300, loss 0.038
Epoch 600, loss 0.020
Epoch 900, loss 0.017
Epoch 1200, loss 0.016
Epoch 1500, loss 0.015
Epoch 1800, loss 0.015
Epoch 2100, loss 0.014
Epoch 2400, loss 0.014
Epoch 2700, loss 0.013
Epoch 3000, loss 0.013
Epoch 3300, loss 0.012
Epoch 3600, loss 0.011
Epoch 3900, loss 0.011
Epoch 4200, loss 0.010
Epoch 4500, loss 0.010
Epoch 4800, loss 0.009
Epoch 5100, loss 0.009
Epoch 5400, loss 0.009
Epoch 5700, loss 0.009
Training ensemble member 2
Epoch 0, loss 5.152
Epoch 300, loss 0.040
Epoch 600, loss 0.018
Epoch 900, loss 0.016
Epoch 1200, loss 0.014
Epoch 1500, loss 0.014
Epoch 1800, loss 0.013
Epoch 2100, loss 0.012
Epoch 2400, loss 0.012
Epoch 2700, loss 0.011
Epoch 3000, loss 0.011
Epoch 3300, loss 0.010
Epoch 3600, loss 0.010
Epoch 3900, loss 0.010
Epoch 4200, loss 0.009
Epoch 4500, loss 0.009
Epoch 4800, loss 0.009
Epoch 5100, loss 0.009
Epoch 5400, loss 0.009
Epoch 5700, loss 0.009
Training ensemble member 3
Epoch 0, loss 14.183
Epoch 300, loss 0.090
Epoch 600, loss 0.053
Epoch 900, loss 0.036
Epoch 1200, loss 0.025
Epoch 1500, loss 0.019
Epoch 1800, loss 0.015
Epoch 2100, loss 0.014
Epoch 2400, loss 0.013
Epoch 2700, loss 0.012
Epoch 3000, loss 0.012
Epoch 3300, loss 0.012
Epoch 3600, loss 0.011
Epoch 3900, loss 0.011
Epoch 4200, loss 0.011
Epoch 4500, loss 0.011
Epoch 4800, loss 0.010
Epoch 5100, loss 0.010
Epoch 5400, loss 0.010
Epoch 5700, loss 0.010
Training ensemble member 4
Epoch 0, loss 72.144
Epoch 300, loss 0.123
Epoch 600, loss 0.054
Epoch 900, loss 0.025
Epoch 1200, loss 0.015
Epoch 1500, loss 0.014
Epoch 1800, loss 0.013
Epoch 2100, loss 0.013
Epoch 2400, loss 0.013
Epoch 2700, loss 0.013
Epoch 3000, loss 0.013
Epoch 3300, loss 0.013
Epoch 3600, loss 0.013
Epoch 3900, loss 0.013
Epoch 4200, loss 0.012
Epoch 4500, loss 0.012
Epoch 4800, loss 0.012
Epoch 5100, loss 0.012
Epoch 5400, loss 0.011
Epoch 5700, loss 0.011</code></pre>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>y_preds_list <span class="op">=</span> []</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trained_params <span class="kw">in</span> ensemble_params_list:</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        y_hat_trained <span class="op">=</span> mlp(test_x, trained_params)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        y_hat_trained <span class="op">=</span> y_hat_trained.cpu().numpy()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        y_preds_list.append(y_hat_trained)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>plot_deep_ensemble(test_x.cpu(), y_preds_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-46-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>plot_deep_ensemble_uncertainty(test_x.cpu(), y_preds_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-47-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>plot_just_uncertainty_deep_ensemble(test_x.cpu(), y_preds_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="mc-dropout-with-residual-connections" class="level2">
<h2 class="anchored" data-anchor-id="mc-dropout-with-residual-connections">MC-dropout with residual connections</h2>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Rewriting the model with dropout</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>input_dim <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>hidden_l1_dim <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>hidden_l2_dim <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_params():</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    W1 <span class="op">=</span> nn.Parameter(torch.randn(input_dim, hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    b1 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l1_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    W2 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l1_dim, hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> nn.Parameter(torch.zeros(hidden_l2_dim, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    W3 <span class="op">=</span> nn.Parameter(torch.randn(hidden_l2_dim, <span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    b3 <span class="op">=</span> nn.Parameter(torch.zeros(<span class="dv">1</span>, requires_grad<span class="op">=</span><span class="va">True</span>).to(device))</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [W1, b1, W2, b2, W3, b3]</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mlp_dropout(x, params, p<span class="op">=</span><span class="fl">0.0</span>, training<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    W1, b1, W2, b2, W3, b3 <span class="op">=</span> params</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    h1 <span class="op">=</span> torch.tanh(x <span class="op">@</span> W1 <span class="op">+</span> b1)</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#####################</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We don't want to apply dropout to the input layer</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#####################</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if training:</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># probability of dropping out each neuron</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mask = torch.rand_like(h1) &gt; p</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># h1 = h1 * mask</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scale activations to account for dropout</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">#h1 = h1 / (1 - p)</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> torch.tanh(h1 <span class="op">@</span> W2 <span class="op">+</span> b2)</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> training:</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># probability of dropping out each neuron</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.rand_like(h2) <span class="op">&gt;</span> p</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> h2 <span class="op">*</span> mask</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scale activations to account for dropout</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>        h2 <span class="op">=</span> h2 <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> p)</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add residual connection</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>    h2 <span class="op">=</span> h2 <span class="op">+</span> h1</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>    h3 <span class="op">=</span> h2 <span class="op">@</span> W3 <span class="op">+</span> b3</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> h3.ravel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> init_params()</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue with optimizer</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(parameters, lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>trained_params <span class="op">=</span> train(parameters, optimizer, mlp_dropout, train_x, train_y, epochs<span class="op">=</span><span class="dv">6000</span>, dropout<span class="op">=</span><span class="va">True</span>, p<span class="op">=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 0, loss 35.309
Epoch 300, loss 3.127
Epoch 600, loss 0.516
Epoch 900, loss 0.224
Epoch 1200, loss 0.117
Epoch 1500, loss 0.100
Epoch 1800, loss 0.080
Epoch 2100, loss 0.062
Epoch 2400, loss 0.053
Epoch 2700, loss 0.049
Epoch 3000, loss 0.047
Epoch 3300, loss 0.047
Epoch 3600, loss 0.039
Epoch 3900, loss 0.037
Epoch 4200, loss 0.034
Epoch 4500, loss 0.039
Epoch 4800, loss 0.035
Epoch 5100, loss 0.033
Epoch 5400, loss 0.033
Epoch 5700, loss 0.039</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions with dropout</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    y_hat_dropout <span class="op">=</span> mlp_dropout(test_x, trained_params, training<span class="op">=</span><span class="va">False</span>).ravel()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Detach and convert to numpy</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>y_hat_dropout <span class="op">=</span> y_hat_dropout.cpu().detach().numpy()</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>plot_predictions(test_x.cpu(), y_hat_dropout)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-51-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predictions for the test set with dropout set to True</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> []</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        y_hat_dropout <span class="op">=</span> mlp_dropout(test_x, trained_params, training<span class="op">=</span><span class="va">True</span>, p<span class="op">=</span>p).ravel()</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detach and convert to numpy</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    y_hat_dropout <span class="op">=</span> y_hat_dropout.cpu().detach().numpy()</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    preds.append(y_hat_dropout)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> np.array(preds)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>(100, 1000)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and variance of MC dropout predictions</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> preds.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>std <span class="op">=</span> preds.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_predictions_with_uncertainty(x_test, y_preds, y_std):</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        ax.plot(x_test, y_preds, <span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'neural net prediction'</span>)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(x_test.ravel(), y_preds <span class="op">-</span> y_std, y_preds <span class="op">+</span> y_std, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'uncertainty'</span>)</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>plot_predictions_with_uncertainty(test_x.cpu(), mean, std)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-53-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Just plot the uncertainty</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_uncertainty(x_test, y_std):</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_predictions(ax):</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(x_test.ravel(), <span class="op">-</span>y_std, y_std, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'C2'</span>, label<span class="op">=</span><span class="st">'uncertainty'</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    plot_generic(add_predictions)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>plot_uncertainty(test_x.cpu(), std)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="monte-carlo-dropout_files/figure-html/cell-54-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>